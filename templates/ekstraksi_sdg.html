<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Extraction</title>

  <!-- Tailwind (CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            brand: '#0165a4',
            'brand-soft': '#e7f1fa',
          },
          boxShadow: {
            card: '0 6px 28px rgba(1,101,164,0.08)'
          },
          borderRadius: {
            xl2: '1.25rem'
          }
        }
      }
    }
  </script>
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <style>
    html,body{font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif}
    input[type=file].file-hidden{position:absolute;left:-9999px;}
    tr[data-row]{ transition: background-color .18s ease }

    /* mini style untuk see more */
    .see-toggle{font-size:.75rem; line-height:1rem}
  </style>
</head>
<body class="bg-white text-slate-800">
  <!-- NAVBAR (STATIC / TIDAK NGIKUT) -->
  <header class="bg-brand text-white shadow-sm">
    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <div class="flex h-16 items-center justify-between">
        <!-- Left: Logo -->
        <a href="/ekstraksi" class="flex items-center gap-3">
          <img src="/assets/img/Unair Branding.png" alt="UNAIR" class="h-9" />
        </a>
  
        <!-- Mobile toggle -->
        <button id="navToggle" class="md:hidden inline-flex items-center justify-center w-10 h-10 rounded-lg hover:bg-brand/80">
          <svg width="20" height="20" fill="none" viewBox="0 0 24 24" class="text-white">
            <path stroke="currentColor" stroke-width="2" d="M4 7h16M4 12h16M4 17h16"/>
          </svg>
        </button>
  
        <!-- Menu (Desktop) -->
        <nav id="navMenu" class="hidden md:flex items-center gap-6">
          <a href="/ekstraksi" class="text-white/90 hover:text-white transition text-sm">Extraction</a>
          <a href="/analytics" class="text-white/90 hover:text-white transition text-sm">Analytics</a>
          <a href="{{ request.url_for('logout') }}"
             class="ml-2 inline-flex items-center gap-2 rounded-full bg-white text-brand px-4 py-1.5 text-sm font-semibold hover:bg-white/90 transition shadow-sm">
            Logout
          </a>
        </nav>
      </div>
  
      <!-- Mobile dropdown -->
      <div id="navDropdown" class="md:hidden hidden border-t border-brand/20 py-2 bg-brand">
        <a href="/deteksi" class="block px-2 py-2 text-sm text-white/90 hover:text-white">Detection</a>
        <a href="/history" class="block px-2 py-2 text-sm text-white/90 hover:text-white">History</a>
        <a href="{{ request.url_for('logout') }}" class="block px-2 py-2 text-sm bg-white text-brand rounded-lg mt-1 text-center hover:bg-white/90">
          Logout
        </a>
      </div>
    </div>
  </header>

  <!-- MAIN -->
  <main class="mx-auto max-w-7xl px-4 sm:px-6 pt-8 pb-6">
    <!-- INPUT CARD -->
    <section class="z-30">
      <div class="rounded-2xl border border-slate-200 shadow-card bg-white overflow-hidden">
        <!-- Header bar -->
        <div class="flex items-center justify-between bg-brand-soft/70 border-b border-slate-200 px-4 sm:px-6 py-3">
          <h2 class="text-brand font-semibold">Upload Rule & Pilih SDG</h2>
          <span class="text-xs md:text-sm text-slate-600 inline-flex items-center gap-1 rounded-full border border-slate-200 bg-white px-3 py-1">Format: <code>.sql</code> atau <code>.txt</code></span>
        </div>

        <div class="px-4 sm:px-6 py-5">
          <form method="post" action="/ekstraksi" enctype="multipart/form-data" id="upload-form" class="flex flex-col gap-5">
            <!-- Dropzone (full width) -->
            <div>
              <label class="block text-sm mb-2 font-medium text-slate-700">File Rule</label>
              <input class="file-hidden" id="fileInput" type="file" name="file" accept=".sql,.txt" required />

              <label for="fileInput" id="dropzone" class="group cursor-pointer flex flex-col items-center justify-center gap-3 rounded-2xl border-2 border-dashed border-slate-300 hover:border-brand bg-slate-50 hover:bg-brand-soft/50 px-4 py-10 text-center transition">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-8 w-8 text-slate-400 group-hover:text-brand"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 15a4 4 0 004 4h10a4 4 0 004-4m-4-5l-4-4m0 0L9 10m4-4v12"/></svg>
                <div class="text-sm">
                  <span class="font-medium">Drag & drop</span> file di sini atau <span class="text-brand underline">klik untuk pilih</span>
                </div>
                <div id="fileName" class="text-xs text-slate-500">Belum ada file dipilih</div>
              </label>
            </div>

            <!-- Row: SDG select (fills left) + Upload button (right) -->
            <div class="grid grid-cols-1 md:grid-cols-[1fr_auto] items-end gap-4">
              <div>
                <label for="sdgs_input" class="block text-sm mb-2 font-medium text-slate-700">SDG Number</label>
                <select id="sdgs_input" name="sdgs_input" required class="w-full rounded-xl border border-slate-300 bg-white px-3 py-2 h-11 text-sm focus:outline-none focus:ring-4 focus:ring-brand/20 focus:border-brand">
                  <option value="" disabled selected>Select SDG Number</option>
                  <option value="1">SDG 1 - No Poverty</option>
                  <option value="2">SDG 2 - Zero Hunger</option>
                  <option value="3">SDG 3 - Good Health and Well-being</option>
                  <option value="4">SDG 4 - Quality Education</option>
                  <option value="5">SDG 5 - Gender Equality</option>
                  <option value="6">SDG 6 - Clean Water and Sanitation</option>
                  <option value="7">SDG 7 - Affordable and Clean Energy</option>
                  <option value="8">SDG 8 - Decent Work and Economic Growth</option>
                  <option value="9">SDG 9 - Industry, Innovation and Infrastructure</option>
                  <option value="10">SDG 10 - Reduced Inequality</option>
                  <option value="11">SDG 11 - Sustainable Cities and Communities</option>
                  <option value="12">SDG 12 - Responsible Consumption and Production</option>
                  <option value="13">SDG 13 - Climate Action</option>
                  <option value="14">SDG 14 - Life Below Water</option>
                  <option value="15">SDG 15 - Life on Land</option>
                  <option value="16">SDG 16 - Peace and Justice Strong Institutions</option>
                  <option value="17">SDG 17 - Partnerships to Achieve the Goal</option>
                </select>
              </div>

              <button type="submit" class="md:justify-self-end w-full md:w-auto inline-flex items-center justify-center gap-2 rounded-full bg-brand px-6 py-3 h-11 text-white text-sm font-medium shadow hover:opacity-95 focus:outline-none focus:ring-4 focus:ring-brand/30 disabled:opacity-50">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4 text-white"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M4 16v2a2 2 0 002 2h12a2 2 0 002-2v-2M7 10l5-5m0 0l5 5m-5-5v12"/></svg>
                Upload
              </button>
            </div>

            {% if error %}
            <div>
              <div class="rounded-xl bg-red-50 text-red-700 px-4 py-3 text-sm border border-red-200">{{ error }}</div>
            </div>
            {% endif %}
          </form>
        </div>
      </div>
    </section>

    <!-- Divider -->
    <div class="h-6"></div>

    <!-- TABLE CARD -->
    <section class="mb-16">
      <div class="rounded-2xl border border-slate-200 shadow-card bg-white overflow-hidden">
        <!-- Header -->
        <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between bg-white border-b border-slate-200 px-4 sm:px-6 py-3">
          <h3 class="text-lg font-semibold text-slate-800">Extracted Results</h3>
          <div class="flex items-center gap-3">
            <div class="relative">
              <input id="searchInput" type="text" placeholder="Search..." class="w-56 md:w-64 rounded-xl border border-slate-300 bg-white pl-9 pr-3 py-2 text-sm focus:outline-none focus:ring-4 focus:ring-brand/20 focus:border-brand"/>
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="pointer-events-none absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-slate-400"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M21 21l-4.3-4.3M10.5 18a7.5 7.5 0 110-15 7.5 7.5 0 010 15z"/></svg>
            </div>
            <form method="post" action="/ekstraksi/delete_all" onsubmit="return confirm('Delete ALL data?');">
              <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-red-200 text-red-700 hover:bg-red-50 px-4 py-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" class="h-4 w-4"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M3 6h18M8 6v12m8-12v12M5 6l1 14a2 2 0 002 2h8a2 2 0 002-2l1-14M9 6V4a1 1 0 011-1h4a1 1 0 011 1v2"/></svg>
                Delete All
              </button>
            </form>
            <form method="get" action="/ekstraksi/download">
              <button type="submit" class="inline-flex items-center gap-2 rounded-full border border-green-200 text-green-700 hover:bg-green-50 px-4 py-2 text-sm">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" stroke="currentColor" class="h-4 w-4" viewBox="0 0 24 24">
                  <!-- Panah ke bawah -->
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M7 10l5 5m0 0l5-5m-5 5V3"/>
                  <!-- Garis bawah -->
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.6" d="M4 20h16"/>
                </svg>
                Download
              </button>
            </form>            
          </div>
        </div>

        <!-- Table wrapper -->
        <div class="px-2 sm:px-4 py-4 overflow-x-auto">
          <table id="data-table" class="min-w-full text-left text-sm">
            <thead class="bg-brand-soft/60 text-slate-700">
              <tr>
                <th data-sort="0" class="px-3 py-2 font-semibold cursor-pointer select-none">SDGs No</th>
                <th data-sort="1" class="px-3 py-2 font-semibold cursor-pointer select-none">No</th>
                <th data-sort="2" class="px-3 py-2 font-semibold cursor-pointer select-none">Jenis</th>
                <th data-sort="4" class="px-3 py-2 font-semibold cursor-pointer select-none">Inclusion</th>
                <th data-sort="6" class="px-3 py-2 font-semibold cursor-pointer select-none">Exclusion</th>
              </tr>
            </thead>
            <tbody id="table-body" class="divide-y divide-slate-100">
              {{ table_rows | safe }}
            </tbody>
          </table>
        </div>

        <!-- Footer: pagination -->
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3 px-4 sm:px-6 py-4 border-t border-slate-200 bg-white">
          <div id="pageInfo" class="text-xs text-slate-500">—</div>
          <div class="flex items-center gap-2">
            <label class="text-xs text-slate-500">Rows/page</label>
            <select id="pageSize" class="rounded-lg border border-slate-300 bg-white px-2 py-1 text-xs focus:outline-none focus:ring-2 focus:ring-brand/20">
              <option value="10" selected>10</option>
              <option value="25">25</option>
              <option value="50">50</option>
            </select>
            <div class="w-px h-6 bg-slate-200 mx-1"></div>
            <nav id="pagin" class="flex items-center gap-1"></nav>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="mt-auto text-center py-8 bg-brand text-white">
    <div class="mx-auto max-w-7xl px-4 sm:px-6">
      <img src="assets/img/Unair Branding.png" class="h-12 mx-auto mb-3" alt="UNAIR" />

      <ul class="flex items-center justify-center gap-4 mb-3">
        <li>
          <a href="https://x.com/Unair_Official" target="_blank" rel="noopener" aria-label="X (Twitter)"
             class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-white/30 hover:bg-white/10 transition">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <path d="M4 4l11.733 16h4.267L8.267 4z"></path>
              <path d="M4 20l6.768-6.768m2.46-2.46l6.772-6.772"></path>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://www.instagram.com/univ_airlangga/" target="_blank" rel="noopener" aria-label="Instagram"
             class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-white/30 hover:bg-white/10 transition">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <path d="M4 8a4 4 0 0 1 4-4h8a4 4 0 0 1 4 4v8a4 4 0 0 1-4 4H8a4 4 0 0 1-4-4V8z"></path>
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M16.5 7.5h.01"></path>
            </svg>
          </a>
        </li>
        <li>
          <a href="https://www.youtube.com/channel/UCUYwloXmWyNZplsqg4MVERw" target="_blank" rel="noopener" aria-label="YouTube"
             class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-white/30 hover:bg-white/10 transition">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-white">
              <rect x="2" y="4" width="20" height="16" rx="4"></rect>
              <path d="M10 9l5 3-5 3z"></path>
            </svg>
          </a>
        </li>
      </ul>

      <div class="text-xs sm:text-sm opacity-90">Copyright © 2025 UNAIR</div>
    </div>
  </footer>
    <!-- LOADING OVERLAY -->
  <div id="loadingOverlay" class="fixed inset-0 z-[120] hidden">
    <div class="absolute inset-0 bg-slate-900/50 backdrop-blur-sm"></div>
    <div class="relative min-h-full flex items-center justify-center p-6">
      <div class="w-full max-w-md rounded-2xl bg-white shadow-card ring-1 ring-slate-200 p-6 text-center">
        <!-- spinner -->
        <div class="mx-auto h-12 w-12 rounded-full border-4 border-slate-200 border-t-brand animate-spin"></div>

        <h4 class="mt-4 font-semibold text-slate-900">Processing your file…</h4>
        <p id="loadingMessage" class="mt-1 text-sm text-slate-600">Uploading rule file…</p>

        <div class="mt-4 h-2 w-full bg-slate-100 rounded-full overflow-hidden">
          <div id="loadingBar" class="h-2 bg-brand/70 rounded-full transition-all" style="width:18%"></div>
        </div>

        <p class="mt-2 text-xs text-slate-500">Waktu proses bergantung ukuran file & jumlah rules.</p>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const form = document.getElementById('upload-form');
      if (!form) return;
  
      const overlay  = document.getElementById('loadingOverlay');
      const msgEl    = document.getElementById('loadingMessage');
      const barEl    = document.getElementById('loadingBar');
      const btn      = form.querySelector('button[type="submit"]');
      const fileEl   = document.getElementById('fileInput');
  
      // Step message yang berputar biar ga sepi
      const steps = [
        'Uploading rule file…',
        'Parsing SQL/TXT rules…',
        'Normalizing & tokenizing…',
        'Building inclusion/exclusion…',
        'Rendering extracted table…'
      ];
      let idx = 0, timer = null, width = 15;
  
      function showOverlay(){
        overlay.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
  
        idx   = 0;
        width = 18;
        msgEl.textContent = steps[0];
        barEl.style.width = width + '%';
  
        timer = setInterval(()=>{
          idx = (idx + 1) % steps.length;
          msgEl.textContent = steps[idx];
          width = Math.min(95, width + 12);
          barEl.style.width = width + '%';
        }, 1100);
      }
  
      function hideOverlay(){
        overlay.classList.add('hidden');
        document.body.classList.remove('overflow-hidden');
        if (timer) { clearInterval(timer); timer = null; }
        barEl.style.width = '18%';
      }
  
      // Saat submit: tampilkan overlay, kunci tombol
      form.addEventListener('submit', function(){
        // Validasi simple: pastikan ada file & SDG dipilih
        const hasFile = fileEl && fileEl.files && fileEl.files.length > 0;
        const sdgSel  = document.getElementById('sdgs_input');
        const hasSdg  = sdgSel && sdgSel.value;
  
        if (!hasFile || !hasSdg) return; // biar native validation jalan
  
        showOverlay();
        if (btn){
          btn.disabled = true;
          btn.dataset.orig = btn.innerHTML;
          btn.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-2 animate-spin" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <circle cx="12" cy="12" r="9" stroke-width="2" class="text-slate-300"></circle>
              <path d="M21 12a9 9 0 0 0-9-9" stroke-width="2" class="text-brand"></path>
            </svg> Processing…`;
        }
      });
  
      // Safety: ketika halaman tujuan sudah termuat / ditinggalkan
      window.addEventListener('pageshow', hideOverlay);
      window.addEventListener('pagehide', hideOverlay);
    })();
  </script>
  
  <!-- SCRIPTS -->
  <script>
    // ===== Drag & Drop file =====
    (function(){
      const dz = document.getElementById('dropzone');
      const fi = document.getElementById('fileInput');
      const fn = document.getElementById('fileName');

      const updateLabel = () => {
        if (fi.files && fi.files.length) {
          fn.textContent = fi.files[0].name;
        } else {
          fn.textContent = 'Belum ada file dipilih';
        }
      }

      ['dragenter','dragover'].forEach(evt => dz.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.add('ring-2','ring-brand/40','bg-brand-soft/70'); }))
      ;['dragleave','drop'].forEach(evt => dz.addEventListener(evt, e=>{ e.preventDefault(); e.stopPropagation(); dz.classList.remove('ring-2','ring-brand/40','bg-brand-soft/70'); }))

      dz.addEventListener('drop', e => {
        const dt = e.dataTransfer;
        if (!dt || !dt.files || !dt.files.length) return;
        const file = dt.files[0];
        const ok = /(\.sql|\.txt)$/i.test(file.name);
        if (!ok){ alert('Only .sql or .txt allowed'); return; }
        fi.files = dt.files;
        updateLabel();
      });

      fi.addEventListener('change', updateLabel);
      updateLabel();
    })();

    // ===== Helper: truncate + See more for a column by header text =====
    function setupSeeMoreForColumn(headerText, limit = 100){
      const theadThs = Array.from(document.querySelectorAll('#data-table thead th'));
      const idx = theadThs.findIndex(th => th.textContent.trim().toLowerCase() === headerText.trim().toLowerCase());
      if (idx === -1) return; // header not found

      const rows = document.querySelectorAll('#table-body tr');
      rows.forEach(tr => {
        const td = tr.children[idx];
        if (!td) return;
        const full = (td.textContent || '').trim();
        if (full.length <= limit) return;

        td.setAttribute('data-fulltext', full);

        const short = full.slice(0, limit) + '…';
        td.innerHTML = `
          <span class="ex-short">${short}</span>
          <span class="ex-full hidden">${full}</span>
          <button type="button" class="see-toggle ml-2 text-brand hover:underline">See more</button>
        `;

        const btn = td.querySelector('.see-toggle');
        const shortSpan = td.querySelector('.ex-short');
        const fullSpan  = td.querySelector('.ex-full');

        btn.addEventListener('click', () => {
          const expanded = !fullSpan.classList.contains('hidden');
          if (expanded){
            fullSpan.classList.add('hidden');
            shortSpan.classList.remove('hidden');
            btn.textContent = 'See more';
          } else {
            shortSpan.classList.add('hidden');
            fullSpan.classList.remove('hidden');
            btn.textContent = 'See less';
          }
        });
      });
    }

    // ===== Simple Table (search, sort, pagination) =====
    (function(){
      const tbody = document.getElementById('table-body');
      if (!tbody) return;

      // Apply "See more" on Exclusion BEFORE we snapshot rows
      setupSeeMoreForColumn('Exclusion', 100);

      const allRows = Array.from(tbody.querySelectorAll('tr'));
      allRows.forEach(r=> r.setAttribute('data-row',''));

      const pageInfo = document.getElementById('pageInfo');
      const pagin = document.getElementById('pagin');
      const pageSizeSel = document.getElementById('pageSize');
      const searchInput = document.getElementById('searchInput');

      let filtered = [...allRows];
      let currentPage = 1;
      let pageSize = parseInt(pageSizeSel.value,10) || 10;
      let sortIndex = 0;
      let sortDir = 'asc';

      function compare(a,b){
        const ta = (a.cells[sortIndex]?.innerText || '').toLowerCase();
        const tb = (b.cells[sortIndex]?.innerText || '').toLowerCase();
        if (ta < tb) return sortDir==='asc' ? -1 : 1;
        if (ta > tb) return sortDir==='asc' ? 1 : -1;
        return 0;
      }

      function render(){
        filtered.sort(compare);
        const total = filtered.length;
        const pages = Math.max(1, Math.ceil(total / pageSize));
        if (currentPage > pages) currentPage = pages;
        const start = (currentPage - 1) * pageSize;
        const end = Math.min(start + pageSize, total);

        allRows.forEach(r=> r.classList.add('hidden'));
        for(let i=start;i<end;i++) filtered[i].classList.remove('hidden');

        pageInfo.textContent = total ? `Showing ${start+1}–${end} of ${total}` : 'No data';

        pagin.innerHTML = '';
        const makeBtn = (label, disabled, onClick, active=false)=>{
          const btn = document.createElement('button');
          btn.type = 'button';
          btn.className = `min-w-[2.25rem] h-9 px-2 rounded-lg border text-sm ${active? 'bg-brand text-white border-brand' : 'bg-white text-slate-700 border-slate-200 hover:border-brand'} ${disabled? 'opacity-50 cursor-not-allowed' : ''}`;
          btn.textContent = label;
          if (!disabled) btn.addEventListener('click', onClick);
          pagin.appendChild(btn);
        }
        makeBtn('Prev', currentPage===1, ()=>{ currentPage--; render(); });

        const pagesToShow = 5;
        const half = Math.floor(pagesToShow/2);
        let startPage = Math.max(1, currentPage - half);
        let endPage = Math.min(pages, startPage + pagesToShow - 1);
        if (endPage - startPage + 1 < pagesToShow) startPage = Math.max(1, endPage - pagesToShow + 1);
        for(let p=startPage; p<=endPage; p++){
          makeBtn(String(p), false, ()=>{ currentPage = p; render(); }, p===currentPage);
        }
        makeBtn('Next', currentPage===pages, ()=>{ currentPage++; render(); });
      }

      // SEARCH (pakai fulltext juga kalau ada)
      searchInput.addEventListener('input', ()=>{
        const q = searchInput.value.trim().toLowerCase();
        if (!q){
          filtered = [...allRows];
        } else {
          filtered = allRows.filter(tr => {
            const base = tr.innerText.toLowerCase();
            const fulls = Array.from(tr.querySelectorAll('[data-fulltext]')).map(el => (el.getAttribute('data-fulltext')||'').toLowerCase()).join(' ');
            return (base + ' ' + fulls).includes(q);
          });
        }
        currentPage = 1; render();
      });

      // page size
      pageSizeSel.addEventListener('change', ()=>{ pageSize = parseInt(pageSizeSel.value,10) || 10; currentPage = 1; render(); });

      // sort by header click
      document.querySelectorAll('th[data-sort]').forEach(th => {
        th.addEventListener('click', ()=>{
          const idx = parseInt(th.getAttribute('data-sort'),10) || 0;
          if (sortIndex === idx){ sortDir = (sortDir==='asc'?'desc':'asc'); }
          else { sortIndex = idx; sortDir = 'asc'; }
          render();
        });
      });

      render();
    })();
  </script>
</body>
</html>
